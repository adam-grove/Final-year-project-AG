---
title: "MALDIquant"
output: html_document
date: "2024-06-10"
---
# Introduction 

# Installing required packaged
```{R}
library("MALDIquant")
library("MALDIquantForeign")
```
# Loading in the data 
The data needs to be loaded in using the package MALDIquantForeign 
```{R, include = FALSE}
df <- importMzMl("C:\\Users\\adamg\\OneDrive - The University of Liverpool\\Project Work\\Data\\Combined Files")

file_names <- list.files("C:\\Users\\adamg\\OneDrive - The University of Liverpool\\Project Work\\Data\\Combined Files")
```
# Taking a look at the data- quality control
Making sure that all files contain the same number of data points and are not empty
```{R}
# Looking for empties
any(sapply(df, isEmpty))

# Number of spectra 
table(sapply(df, length))

```
```{R}
# Visual inspection of the data
plot(df[[1]])
```

# Adjustable parameters
```{R, include = FALSE}
# Sqrt transformation 
spectra <- transformIntensity(df,method="sqrt")

# Data smoothing
spectra <- smoothIntensity(spectra, method="SavitzkyGolay", halfWindowSize=10)

# Baseline correction 
spectra <- removeBaseline(spectra, method="SNIP", iterations=100)
```

# Calibration 
```{R}
spectra <- calibrateIntensity(spectra,method = "TIC")
```

# Aligning the spectra
Uses peak based warping algorithms. 
```{R}
spectra <- alignSpectra(spectra,halfWindowSize=20,SNR=2,tolerance=0.002,warpingMethod="lowess")
```

# Peak detection 
```{R}

# Can use this code here to investigate the signal to noise ratio 
noise <- estimateNoise(spectra[[1]])
plot(spectra[[1]])
lines(noise, col="red")
lines(noise[,1], noise[, 2]*5, col="blue")
```

```{R}
peaks <- detectPeaks(spectra, method="MAD", halfWindowsize = 20, SNR= 5)
plot(spectra[[1]])
points(peaks[[1]],col = "red", pch=4)

# Binning the peaks
peaks <- binPeaks(peaks, tolerance=0.002)
peaks <- filterPeaks(peaks, minFrequency=0.10)
```

# File output
```{R}
featureMatrix <- intensityMatrix(peaks,spectra)
```

```{R}
library(data.table)

file_names <- sub("Combined_(.*)\\.mzML", "\\1", file_names)


rownames(featureMatrix) <- file_names



write.csv(featureMatrix,"MALDIquant_Feature_Values.csv") 
```